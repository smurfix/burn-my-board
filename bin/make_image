#!/bin/bash

set -ex

source helper/common

usage() {
    cat <<'___'
Usage: make_image [:target] dest [root [boot]]

Create an image.

dest: Destination device (or image). Will be overwritten!
root: Root file system (directory or image).
boot: /boot partition file system (directory or image).

If root/boot are not given they are (ephemerally) created in /var/tmp.
___
    exit 1
}

test "$#" -gt 0 || usage

source snips/$TARGET/partinfo

R=$T/root
mkdir -p $R
if test -z "$1" || test "$1" = "--" ; then
    echo "You need to supply a place to store the image."
    exit 1
elif test -b "$1" ; then
    IMG="$1"
    IMGP="$IMG"
    if ! test -b ${IMGP}${P_ROOT} ; then
        sudo sfdisk "$1" < $T/partinfo
        udevadm settle
    fi
else
    if ! test -s "$1" ; then
        sudo dd bs=512 if=/dev/zero of="$1" count=$DEVICE_SIZE
        sudo sfdisk "$1" < $T/partinfo
    fi
    IMG=$(loopback "$1" -P)
    IMGP="$IMG"p
fi
shift

sudo blkid ${IMGP}${P_BOOT} | grep -qs TYPE= || \
sudo ${MKFS_BOOT} ${IMG}${P_BOOT}
sudo blkid ${IMGP}${P_ROOT} | grep -qs TYPE= || \
sudo ${MKFS_ROOT} ${IMG}${P_ROOT}

# TODO build in a dir and copy
bin/make_root ${IMGP}${P_ROOT} ${IMGP}${P_BOOT} "$@"
bin/make_loader

source snips/$TARGET/write_loader

test -b "$IMG" && sudo eject "$IMG"

